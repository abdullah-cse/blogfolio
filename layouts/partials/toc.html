{{ if and (.Site.Params.showTOC | default true) (not .Params.disable_toc) }}
{{ $toc := .TableOfContents }}
{{ if gt (len $toc) 100 }}
<aside class="toc-wrapper">
  <div class="toc-container">
    <button class="toc-toggle" aria-label="Toggle table of contents" aria-expanded="false" type="button" onclick="toggleTOC()">
      <svg class="toc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
      <span class="toc-title">Table of Contents</span>
      <svg class="toc-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>
    
    <nav class="toc-content" aria-label="Table of contents">
      {{ $toc | safeHTML }}
    </nav>
  </div>
</aside>

<script>
  // Global toggle function for mobile
  function toggleTOC() {
    const toggle = document.querySelector('.toc-toggle');
    const content = document.querySelector('.toc-content');
    
    if (!toggle || !content) {
      console.log('TOC elements not found');
      return;
    }
    
    // Only toggle on mobile
    if (window.innerWidth < 1024) {
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
      console.log('Current state:', isExpanded, 'Window width:', window.innerWidth);
      
      toggle.setAttribute('aria-expanded', String(!isExpanded));
      
      if (!isExpanded) {
        content.classList.add('expanded');
      } else {
        content.classList.remove('expanded');
      }
      
      console.log('New state:', toggle.getAttribute('aria-expanded'));
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.querySelector('.toc-toggle');
    const content = document.querySelector('.toc-content');
    
    if (!toggle || !content) {
      console.log('TOC not found on page');
      return;
    }
    
    console.log('TOC initialized');
    
    // Initialize state based on screen size
    function initTOCState() {
      if (window.innerWidth >= 1024) {
        // Desktop: always expanded, disable toggle
        content.classList.add('expanded');
        toggle.style.cursor = 'default';
        console.log('Desktop mode - TOC always visible');
      } else {
        // Mobile: collapsed by default
        content.classList.remove('expanded');
        toggle.setAttribute('aria-expanded', 'false');
        toggle.style.cursor = 'pointer';
        console.log('Mobile mode - TOC collapsible');
      }
    }
    
    // Initialize on load
    initTOCState();
    
    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(initTOCState, 100);
    });
    
    // Smooth scroll for all TOC links
    const tocLinks = content.querySelectorAll('a');
    tocLinks.forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href');
        const targetElement = document.querySelector(targetId);
        
        if (targetElement) {
          const offset = 80;
          const elementPosition = targetElement.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - offset;
          
          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });
          
          // Close TOC on mobile after clicking a link
          if (window.innerWidth < 1024) {
            toggle.setAttribute('aria-expanded', 'false');
            content.classList.remove('expanded');
          }
        }
      });
    });
    
    // Active section highlighting on desktop
    if (window.innerWidth >= 1024) {
      const sections = Array.from(tocLinks).map(function(link) {
        const id = link.getAttribute('href').substring(1);
        return document.getElementById(id);
      }).filter(function(section) {
        return section !== null;
      });
      
      function highlightActiveTOC() {
        const scrollPos = window.scrollY + 100;
        let currentSection = null;
        
        sections.forEach(function(section) {
          if (section.offsetTop <= scrollPos) {
            currentSection = section;
          }
        });
        
        tocLinks.forEach(function(link) {
          link.classList.remove('active');
          if (currentSection && link.getAttribute('href') === '#' + currentSection.id) {
            link.classList.add('active');
          }
        });
      }
      
      window.addEventListener('scroll', highlightActiveTOC);
      highlightActiveTOC();
    }
  });
</script>
{{ end }}
{{ end }}